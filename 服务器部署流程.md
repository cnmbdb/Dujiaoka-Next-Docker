# Dujiao-Next æœåŠ¡å™¨éƒ¨ç½²æµç¨‹

## ğŸ“‹ éƒ¨ç½²å‰å‡†å¤‡

### æœåŠ¡å™¨è¦æ±‚

- **ç³»ç»Ÿ**: Linux (Ubuntu 20.04+ / CentOS 7+ / Debian 10+)
- **å†…å­˜**: è‡³å°‘ 2GB
- **ç£ç›˜**: è‡³å°‘ 10GB å¯ç”¨ç©ºé—´
- **ç½‘ç»œ**: å¯è®¿é—® Docker Hub

### å¿…éœ€è½¯ä»¶

- Docker >= 20.10
- Docker Compose >= 2.0

---

## ğŸš€ å®Œæ•´éƒ¨ç½²æµç¨‹

### ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ éƒ¨ç½²æ–‡ä»¶åˆ°æœåŠ¡å™¨

å°†ä»¥ä¸‹æ–‡ä»¶/ç›®å½•ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼ˆå¦‚ `/opt/dujiao-next/`ï¼‰ï¼š

```
dujiao-next/
â”œâ”€â”€ docker-compose.yml      # æ ¸å¿ƒç¼–æ’æ–‡ä»¶
â”œâ”€â”€ .env                    # å”¯ä¸€ç¯å¢ƒå˜é‡æ–‡ä»¶
â”œâ”€â”€ config/
â”‚   â””â”€â”€ config.yml          # API é…ç½®æ–‡ä»¶ï¼ˆé‡è¦ï¼ï¼‰
â””â”€â”€ nginx/                  # å‰ç«¯åå‘ä»£ç†é…ç½®
```

**ä¸Šä¼ æ–¹å¼ç¤ºä¾‹**ï¼š
```bash
# æ–¹å¼1ï¼šä½¿ç”¨ scp
scp -r Dujiao-Next/* user@your-server:/opt/dujiao-next/

# æ–¹å¼2ï¼šä½¿ç”¨ rsync
rsync -avz --exclude 'data' --exclude '.git' Dujiao-Next/ user@your-server:/opt/dujiao-next/

# æ–¹å¼3ï¼šæ‰“åŒ…åä¸Šä¼ 
tar -czvf dujiao-next-deploy.tar.gz docker-compose.yml .env config/ nginx/
scp dujiao-next-deploy.tar.gz user@your-server:/opt/
# åœ¨æœåŠ¡å™¨ä¸Šè§£å‹: tar -xzvf dujiao-next-deploy.tar.gz
```

---

### ç¬¬äºŒæ­¥ï¼šå®‰è£… Dockerï¼ˆå¦‚æœªå®‰è£…ï¼‰

```bash
# Ubuntu/Debian
curl -fsSL https://get.docker.com | sh
sudo systemctl enable docker
sudo systemctl start docker

# å®‰è£… Docker Compose
sudo apt install docker-compose-plugin
# æˆ–
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
```

---

### ç¬¬ä¸‰æ­¥ï¼šé…ç½®ç¯å¢ƒå˜é‡

```bash
cd /opt/dujiao-next

# 1. åˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶
# ä»…ç»´æŠ¤ä¸€ä¸ª .env æ–‡ä»¶
vim .env

# 2. ç¼–è¾‘é…ç½®ï¼ˆå¿…é¡»ä¿®æ”¹ï¼‰
# .env æ”¹å®Œåï¼Œé‡å¯å®¹å™¨ç”Ÿæ•ˆ
docker compose up -d
```

**å¿…é¡»ä¿®æ”¹çš„é…ç½®é¡¹**ï¼š

| å˜é‡ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `DB_PASSWORD` | æ•°æ®åº“å¯†ç ï¼ˆå¼ºå¯†ç ï¼‰ | `MyStr0ng!Pass@2024` |
| `TAG` | é•œåƒç‰ˆæœ¬ | `v0.0.3-beta` |
| `USER_PORT` | å‰å°ç«¯å£ | `3000` |
| `API_PORT` | API ç«¯å£ | `3001` |
| `ADMIN_PORT` | åå°ç«¯å£ | `3002` |

```bash
# 3. åŒæ­¥ config.yml ä¸­çš„æ•°æ®åº“å¯†ç 
vim config/config.yml
# ä¿®æ”¹ database.dsn ä¸­çš„ password ä¸ .env ä¸€è‡´
# ä¿®æ”¹ jwt.secret å’Œ user_jwt.secretï¼ˆç”Ÿäº§ç¯å¢ƒç”¨å¼ºéšæœºå­—ç¬¦ä¸²ï¼‰
```

---

### ç¬¬å››æ­¥ï¼šé…ç½® API é…ç½®æ–‡ä»¶

ç¼–è¾‘ `config/config.yml`ï¼š

```bash
vim config/config.yml
```

**å…³é”®é…ç½®**:
- `database.dsn`: æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼ˆå¯†ç éœ€ä¸ .env ä¸€è‡´ï¼‰
- `server.mode`: ç”Ÿäº§ç”¨ `release` æ—¶ï¼ŒJWT å¯†é’¥éœ€ â‰¥32 ä½ä¸”ä¸å«å¼±å…³é”®è¯
- `jwt.secret` / `user_jwt.secret`: ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨å¼ºéšæœºå¯†é’¥

**ç”Ÿæˆå¼ºå¯†é’¥**:
```bash
openssl rand -hex 32
```

---

### ç¬¬äº”æ­¥ï¼šé…ç½®é˜²ç«å¢™ï¼ˆå¦‚å¯ç”¨ï¼‰

```bash
# å¼€æ”¾ç«¯å£
sudo ufw allow 3000/tcp   # User å‰å°
sudo ufw allow 3001/tcp   # API
sudo ufw allow 3002/tcp   # Admin åå°
sudo ufw reload
```

---

### ç¬¬å…­æ­¥ï¼šæ‰§è¡Œéƒ¨ç½²

```bash
cd /opt/dujiao-next

# æ–¹å¼1ï¼šä½¿ç”¨éƒ¨ç½²è„šæœ¬ï¼ˆæ¨èï¼‰
docker compose pull
docker compose up -d
```

---

### ç¬¬ä¸ƒæ­¥ï¼šéªŒè¯éƒ¨ç½²

```bash
# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker compose ps

# æµ‹è¯•è®¿é—®
curl http://localhost:3000   # User å‰å°
curl http://localhost:3001/api/v1/public/config  # API
curl http://localhost:3002   # Admin åå°
```

åœ¨æµè§ˆå™¨è®¿é—®ï¼š
- **ç”¨æˆ·å‰å°**: `http://æœåŠ¡å™¨IP:3000`
- **åå°ç®¡ç†**: `http://æœåŠ¡å™¨IP:3002`
- **API æ¥å£**: `http://æœåŠ¡å™¨IP:3001`

---

## ğŸ“ éƒ¨ç½²æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | å¿…éœ€ | è¯´æ˜ |
|------|------|------|
| `docker-compose.yml` | âœ… | Docker ç¼–æ’é…ç½® |
| `config/config.yml` | âœ… | API é…ç½®ï¼ˆæ•°æ®åº“ã€Redisã€JWT ç­‰ï¼‰ |
| `.env` | âœ… | å”¯ä¸€ç¯å¢ƒå˜é‡æ–‡ä»¶ï¼ˆè¿è¡Œæ—¶è¯»å–ï¼‰ |
| `nginx/*.conf` | âœ… | User/Admin Nginx é…ç½® |

---

## ğŸ”§ å¸¸ç”¨è¿ç»´å‘½ä»¤

```bash
# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker compose ps

# æŸ¥çœ‹æ—¥å¿—
docker compose logs -f
docker compose logs -f api    # åªçœ‹ API

# é‡å¯æœåŠ¡
docker compose restart

# åœæ­¢æœåŠ¡
docker compose down

# æ›´æ–°æœåŠ¡
docker compose pull
docker compose up -d --force-recreate
```

---

## âš ï¸ ç”Ÿäº§ç¯å¢ƒæ³¨æ„äº‹é¡¹

1. **ä¿®æ”¹é»˜è®¤å¯†ç **: `DB_PASSWORD`ã€JWT å¯†é’¥å¿…é¡»ä½¿ç”¨å¼ºéšæœºå€¼
2. **é…ç½® HTTPS**: å»ºè®®ä½¿ç”¨ Nginx åå‘ä»£ç†é…ç½® SSL è¯ä¹¦
3. **å¤‡ä»½æ•°æ®**: å®šæœŸå¤‡ä»½ PostgreSQL å’Œ Redis æ•°æ®
4. **é˜²ç«å¢™**: ä»…å¼€æ”¾å¿…è¦ç«¯å£ï¼Œé™åˆ¶æ•°æ®åº“ç«¯å£å¤–ç½‘è®¿é—®
5. **ç›‘æ§**: é…ç½®æœåŠ¡ç›‘æ§å’Œå‘Šè­¦

---

## ğŸ†˜ å¸¸è§é—®é¢˜

### ç«¯å£è¢«å ç”¨
ä¿®æ”¹ `.env` ä¸­çš„ `USER_PORT`ã€`API_PORT`ã€`ADMIN_PORT`

### API æ— æ³•å¯åŠ¨
æ£€æŸ¥ `config/config.yml` ä¸­çš„æ•°æ®åº“è¿æ¥å’Œ JWT å¯†é’¥é…ç½®

### æ— æ³•è®¿é—®
æ£€æŸ¥é˜²ç«å¢™ã€å®‰å…¨ç»„æ˜¯å¦å¼€æ”¾ 3000/3001/3002 ç«¯å£

### è¯¦ç»†æ’æŸ¥
å‚è€ƒ `TROUBLESHOOTING.md` å’Œ `FIXES_APPLIED.md`

---

## ğŸ“ å¿«é€Ÿéƒ¨ç½²å‘½ä»¤æ±‡æ€»

```bash
# ä¸€é”®éƒ¨ç½²ï¼ˆåœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼‰
cd /opt/dujiao-next
vim .env  # ä¿®æ”¹ DB_PASSWORD ç­‰
vim config/config.yml  # ç¡®è®¤æ•°æ®åº“å¯†ç ã€JWT å¯†é’¥
docker compose pull
docker compose up -d
docker compose ps
```
