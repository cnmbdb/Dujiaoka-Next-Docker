# 微信易支付支付网关无法拉起问题排查

## 问题现象
- 后台易支付有订单信息
- 前端无法拉起支付网关（无法跳转到支付页面）

## 镜像版本检查

当前使用的镜像版本：**v0.0.3-beta**（最新版本）

```bash
# 检查镜像版本
docker compose images

# 拉取最新镜像
docker compose pull

# 重启服务
docker compose up -d
```

## 可能的原因

### 1. 支付 URL 生成问题

检查支付订单的 `pay_url` 字段：

```bash
docker compose exec dujiao-postgres psql -U dujiao_user -d dujiao_db -c "SELECT id, status, pay_url, provider_type FROM payments ORDER BY created_at DESC LIMIT 5;"
```

**如果 `pay_url` 为空或 NULL**：
- 可能是易支付配置不正确
- 可能是支付渠道配置有问题

### 2. 前端跳转问题

**检查浏览器控制台**（F12）：
- Network 标签：查看支付 API 请求是否成功
- Console 标签：查看是否有 JavaScript 错误
- 检查 `pay_url` 是否正确返回

### 3. 易支付配置问题

在后台检查易支付配置：
- **商户ID**（pid）
- **商户密钥**（key）
- **支付接口地址**（gateway_url）
- **回调地址**（notify_url）- 必须可访问
- **跳转地址**（return_url）

### 4. 回调地址配置

易支付需要能访问回调地址，确保：
- 回调地址是公网可访问的 URL
- 如果使用域名，确保域名已解析
- 如果使用 IP，确保 IP 可访问且端口开放

### 5. 前端 API 调用

检查前端是否正确调用支付 API：

```bash
# 测试创建支付
curl -X POST http://localhost:3001/api/v1/payments \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "order_id": 1,
    "channel_id": 1
  }'
```

检查返回的 `pay_url` 是否正确。

## 排查步骤

### 1. 检查支付订单

```bash
docker compose exec dujiao-postgres psql -U dujiao_user -d dujiao_db -c "SELECT id, status, pay_url, qr_code, provider_type, created_at FROM payments ORDER BY created_at DESC LIMIT 5;"
```

### 2. 检查支付渠道配置

```bash
docker compose exec dujiao-postgres psql -U dujiao_user -d dujiao_db -c "SELECT id, name, provider_type, channel_type, is_active, config_json FROM payment_channels WHERE deleted_at IS NULL;"
```

### 3. 查看 API 日志

```bash
docker compose logs api --tail=100 | grep -i "payment\|epay\|易支付"
```

### 4. 测试支付 API

```bash
# 获取支付渠道列表
curl http://localhost:3001/api/v1/public/config | jq '.data.payment_channels'
```

## 常见解决方案

### 方案1：检查易支付配置

在后台管理界面：
1. 进入"支付渠道"管理
2. 检查易支付配置
3. 确认所有必填项都已填写
4. 测试保存配置

### 方案2：检查回调地址

确保回调地址格式正确：
- 格式：`http://your-domain.com/api/v1/payments/callback`
- 或：`https://your-domain.com/api/v1/payments/callback`
- 必须是公网可访问的地址

### 方案3：检查前端支付流程

1. 打开浏览器开发者工具（F12）
2. 创建订单并尝试支付
3. 查看 Network 标签中的支付请求
4. 检查返回的 `pay_url` 是否正确
5. 如果 `pay_url` 存在，手动访问该 URL 测试

### 方案4：更新到最新版本

```bash
# 拉取最新镜像
docker compose pull

# 重启服务
docker compose up -d
```

## 已知问题

如果确认是 bug，可以：
1. 查看 GitHub Issues：https://github.com/dujiao-next/dujiao-next/issues
2. 查看更新日志：检查 v0.0.3-beta 是否有支付相关的修复
3. 提交 Issue：描述具体问题，附上日志和配置信息

## 临时解决方案

如果 `pay_url` 已生成但前端无法跳转：
1. 手动复制 `pay_url` 到浏览器访问
2. 检查前端代码是否正确处理 `pay_url` 跳转
3. 检查是否有 CORS 或跨域问题
